"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getLocalEDMXService = void 0;
const url_1 = require("url");
/**
 * Creates local EDMX service structure.
 *
 * @param project - Project structure.
 * @param serviceName - Name of the service that is specified in manifest.
 * @param appName - Name of the application.
 * @returns Service structure.
 */
function getLocalEDMXService(project, serviceName, appName) {
    // find app - use first app if no appName is provided or app with such name doesn't exist
    const app = project.apps[adjustAppNameByProjectData(appName, project)];
    const service = app?.services[serviceName];
    if (!service?.local) {
        // We can not continue without metadata, stop here.
        throw new Error(`Metadata file for service ${serviceName} in app ${appName} is not found!`);
    }
    const metadataFilePath = service.local ?? '';
    const metadataFileUri = (0, url_1.pathToFileURL)(metadataFilePath).toString();
    const metadataFile = { uri: metadataFileUri, isReadOnly: true };
    // Note: Currently multiple backend annotation files are not supported.
    const serviceAnnotations = service?.annotations ?? [];
    const uris = serviceAnnotations.map((item) => (0, url_1.pathToFileURL)(item.local ?? '').toString());
    const backendAnnotationFileIdx = serviceAnnotations.findIndex((annotation, idx) => typeof annotation.local === 'string' &&
        typeof annotation.uri === 'string' &&
        !uris[idx].endsWith(annotation.uri));
    const backendAnnotationFileUri = uris[backendAnnotationFileIdx] ?? '';
    const annotationFiles = uris.map((uri) => {
        const isReadOnly = uri === backendAnnotationFileUri;
        return { uri, isReadOnly };
    });
    return {
        type: 'local-edmx',
        odataVersion: service.odataVersion ?? '2.0',
        metadataFile,
        annotationFiles
    };
}
exports.getLocalEDMXService = getLocalEDMXService;
function adjustAppNameByProjectData(requestedAppName, project) {
    if (requestedAppName && project.apps[requestedAppName]) {
        return requestedAppName;
    }
    else if (project.apps['']) {
        return '';
    }
    else {
        return Object.keys(project.apps)[0] || '';
    }
}
//# sourceMappingURL=service.js.map